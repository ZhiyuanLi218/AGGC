# Format checks enforced on CI:
# 1. Comments must appear above each field.
# 2. There must be a blank line between each field.
# 3. Inline comments (after a field on the same line) are not allowed.
# 4. Indentation level is respected for nested fields.

# defaults specify the default config from each component
defaults:

  # fsdp optimizer config
  - ../optim@optim: fsdp

  # fsdp engine config
  - ../engine@fsdp_config: fsdp

  # dp actor config, inheriting from trainer/config/actor/actor.yaml
  - actor

  # load the reference default config, then apply the fields in the current yaml
  - _self_

# Target class for this configuration
_target_: verl.workers.config.FSDPActorConfig

# TODO(haibin.lin): switch to fsdp2
strategy: fsdp

# Gradient clipping for actor updates, specific to the strategy.
grad_clip: 1.0

# Sequence parallelism size for Ulysses-style model parallelism
# oc.select: the default val for ref.ulysses_sequence_parallel_size
ulysses_sequence_parallel_size: 1

# calculate entropy with chunking to reduce memory peak
entropy_from_logits_with_chunking: False

# recompute entropy
entropy_checkpointing: False

# Whether to remove padding tokens in inputs during training
use_remove_padding: ${oc.select:actor_rollout_ref.model.use_remove_padding,false}

# Per-module gradient norm clipping
per_module_grad_norm:
  enable: false
  auto_bounds: true
  min_norm: 0.0
  max_norm: 1.0
  norm_type: 2.0
  low_mult: 0.95
  high_mult: 0.6
  raise_small: false
  ema_beta: 0.95
  sync_dist: true
  bounds_schedule: linear  # none | linear
  high_mult_late: 0.5
  low_mult_late: 0.98
  bounds_switch_ratio: 0.4
  bounds_transition_ratio: 0.3
  max_up_scale: 1.1
  max_down_scale: 0.9
  output_dir: null
  keep_global_clip: true